<html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta charset="utf-8">
    <title>JSON-RPC Demo for JQuery Terminal Emulator</title>
    <meta name="author" content="Jakub Jankiewicz - jcubic@onet.pl">
    <meta name="Description" content="Demonstration for JQuery Terminal Emulator using call automaticly JSON-RPC service (in php) with authentication.">
    <link rel="shortcut icon" href="favicon.ico">
    <script type="text/javascript" async="" defer="" src="//piwik.jcubic.pl/matomo.js"></script><script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="https://unpkg.com/jquery.terminal/js/jquery.mousewheel-min.js"></script>
    <script src="https://unpkg.com/jquery.terminal/js/jquery.terminal.min.js"></script>
    <script src="js/jquery.terminal.js"></script>

    <link href="https://unpkg.com/jquery.terminal/css/jquery.terminal.min.css" rel="stylesheet">
    <script src="https://unpkg.com/js-polyfills/keyboard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script>
    $(document).ready(function () {
    'use strict';


    function toUnderscore(copyString, line, newChar) {
    copyString[newChar[1]] = newChar[0];
    line.text(copyString.join(''));
    }

    function fromUnderscore(copyString, splitString, newChar, line) {
    copyString[newChar[1]] = splitString[newChar[1]];
    line.text(copyString.join(""));
    }

    function resetForm(withKittens) {
    var message = "Sorry that command is not recognized.";
    var input = $('.404-input');

    if (withKittens) {
    $('.kittens').removeClass('kittens');
    message = "WILL GO TO YOUTUBE after 10 sec ! => ";
    }

    $('.new-output').removeClass('new-output');
    input.val('');
    terminal.append('<p class="prompt">' + message + '</p><p class="prompt output new-output"></p>');
    var index = 0, cnt = 0;
    setInterval(function(){
    index = index + 1;
    cnt = 10 - index;
    if(index == 10) window.location.href = "https://youtube.com";
    terminal.scrollTop(terminal.prop("scrollHeight"));
    }, 1000);

    // $('.new-output').velocity(       'scroll'),  { duration: 100 };
    }

    function showKittens() {
    terminal.append("<div class='kittens'>" +
    "<p class='prompt'></p>" +
    "<p class='prompt' style='font-size: 48px;'><center><b>HAPPY BIRTHDAY TO YOU!</b></center></p>" +
    "<p class='prompt'></p>" +
    "<p class='prompt'></p></div>");


    var lines = $('.kittens p');
    $.each(lines, function (index, line) {
    setTimeout(function () {
    $(line).css({
    "opacity": 1 });


    textEffect($(line));
    terminal.scrollTop(terminal.prop("scrollHeight"));
    }, (index + 3) * 100);
    });

    // $('span.path:last').velocity(        'scroll'), { duration: 100 };

    setTimeout(function () {
    var gif ;
    terminal.scrollTop(terminal.prop("scrollHeight") * 100);
    $.get('http://api.giphy.com/v1/gifs/random?api_key=dc6zaTOxFJmzC&amp;tag=Happy+Birthday+!', function (result) {
    gif = result.data.image_url;
    terminal.append('<img class="kitten-gif" src="' + gif + '"">');
    resetForm(true);
    });
    }, lines.length * 100 + 1000);
    }

    function textEffect(line) {
    var alpha = ['H', 'A', 'P', 'Y', 'B', 'I', 'R', 'T', 'O', 'U', ' '];
    var animationSpeed = 10;
    var index = 0;
    var string = line.text();
    var splitString = string.split("");
    var copyString = splitString.slice(0);

    var emptyString = copyString.map(function (el) {
    return [alpha[Math.floor(Math.random() * alpha.length)], index++];
    });

    emptyString = shuffle(emptyString);

    $.each(copyString, function (i, el) {
    var newChar = emptyString[i];
    toUnderscore(copyString, line, newChar);

    setTimeout(function () {
    fromUnderscore(copyString, splitString, newChar, line);
    }, i * animationSpeed);
    });
    }

    function shuffle(o) {
    for (var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x)
    return o;
    };

    var min = 1, max = 8, pos = 0;
    // UTILITY
    function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
    }
    // END UTILITY


    var title = $('.title');
    var statusObj = $('.status');
    var terminal = $('.terminal');
    var prompt = '>';

    var textlists = [{
      'name':'long-text1.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text2.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text3.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text4.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text5.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text6.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text7.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }, {
      'name':'long-text8.txt',
      'action': 'type',
      'postDelay': 1000,
      'content':''
      }
    ];

    var commandHistory = [];
    var historyIndex = 0;

    var command = '';
    var commands = [{
      'name': '123456789',
      'answers': '123456789',
      'status': 0,
      'function': name },
      {
      'name': 'Enter: Yes',
      'answers': 'Yes',
      'status': 0,
      'function': gender },
      {
      'name': 'Enter: I can wait',
      'answers': "I can wait",
      'status': 0,
      'function': contact },
      {
      'name': 'Start the READING process.\nEnter: Read',
      'answers': 'Read',
      'status': 0,
      'function': stories },
      {
      'name': 'Fetching data from the text file.\nEnter: Start',
      'answers': 'Start',
      'status': 0,
      'function': stories },
      {
      'name': 'Getting content with fun.\nEnter: Get',
      'answers': 'Get',
      'status': 0,
      'function': stories },
      {
      'name': 'Generating story funny.\nEnter: Funny',
      'answers': 'Funny',
      'status': 0,
      'function': stories },
      {
      'name': 'Verifying the content.\nEnter: Verify',
      'answers': 'Verify',
      'status': 0,
      'function': stories },
      {
      'name': 'Read a story about your city life.\nEnter: AAA',
      'answers': 'AAA',
      'status': 0,
      'function': stories },
      {
      'name': 'Read a story about your family life.\nEnter: BBB',
      'answers': 'BBB',
      'status': 0,
      'function': stories },
      {
      'name': 'Read a story about your weekend.\nEnter: CCC',
      'answers': 'CCC',
      'status': 0,
      'function': stories },
      {
      'name': 'Do you want to get a suprise?\nEnter: Y',
      'answers': 'Y',
      'status': 0,
      'function': Ending
      }
    ];

    var status = 0, sltxt = 0;

    // COMMANDS
    function name() {
    terminal.append('<span class="syst">Ready to read this chapter </span> <span class="answer">' + command + '</span>\n\nAgree to the <a href="#">reading process</a>?\n');
    terminal.append(notify);
    }

    function gender() {
    terminal.append('\nReading process takes about 5 minutes. You must confirm that you can wait.\n');
    terminal.append(notify);
    };

    function contact(args) {
    terminal.append('\nSystem is ready...\n');
    terminal.append(notify);
    }

    function stories() {
    terminal.append('\n<span class="syst">Process started:</span> <span class="answer">'+ command +'</span>\n\n');
    //$(".answer").css({"textTransform": "capitalize", "color": "white"});
    pos = sltxt;
    runScripts(textlists, pos);
    sltxt ++;
    }

    function Ending(){
      showKittens();
    }
    // END COMMANDS

    var notify = "", nEdit = 0;
    function processCommand() {
    var isValid = false;

    // Create args list by splitting the command
    // by space characters and then shift off the
    // actual command.

    var args = command.split(' ');
    // var args = [];
    var cmd = args[0];
    args.shift();
    // Iterate through the available commands to find a match.
    // console.log(cmd)
    // Then call that command and pass in any arguments.
    var len = Object.keys(commands).length;
    // console.log(f);
    for (var i = 0; i < len; i++) {
    notify = '';
    status = 0;
    for (var j = 0; j < len; j ++){
    if (commands[j].status == 0){
    status = j;
    break;
    }
    }
    // console.log(command);
    // console.log(commands[i].answers);
    if (command.toUpperCase() === commands[i].answers.toUpperCase()) {
    if(i == status) {
    if(status < len - 1) notify = '\n<span class="syst">'+ commands[status + 1].name +'</span>\n';
    commands[i].function(args);
    isValid = true;
    commands[status].status = 1;
    break;
    }

    break;
    }
    }
    // No match was found...
    if (!isValid) {
    terminal.append('<span class="syst">Wrong answer:</span> <span class="errortxt">'+ command +'</span>\n\n' + notify);
    $('#dummyKeyboard').val('');
    }

    // Add to command history and clean up.
    commandHistory.push(command);
    historyIndex = commandHistory.length;
    command = '';
    }

    function runScripts(data, pos) {
    terminal.append('<span class="typed"></span>');
    var span = $('.terminal .typed:last');
    // var textspan = document.createTextNode("Typing");
    // span.appendChild(textspan);

    var script = data[pos];
    // console.log(script);
    var typing;
    $('.typed-cursor').detach();
    span.text('');
    switch (script.action) {
    case 'type':
    // cleanup for next execution
    span.removeData();
    $('.typed-cursor').detach();
    var bprogress = '#', progress = '',  counters = 0;
    span.typed({
    strings: [script.content + '\n'],
    typeSpeed: 2,
    // character for cursor
    cursorChar: "|",
    // starting callback function before each string
    preStringTyped: function() {
    console.log('before');
    $('.typed-cursor').detach();
    nEdit = 1;
    span.next().text('');
    var beforetxt = terminal.text(),
    bstrOfall = beforetxt.length,
    readytxt = script.content;
    setInterval(typing = function(){
    var nstrOfall = readytxt.length,
    istrOfall = terminal.text().length;
    progress = '';
    // console.log(istrOfall + '/' + parseInt(nstrOfall + bstrOfall));
    terminal.scrollTop(terminal.height() * 100);
    if(istrOfall < nstrOfall + bstrOfall){
    str_percent = parseInt((istrOfall - bstrOfall) * 1000 / nstrOfall) / 10;
    counters = parseInt(str_percent / 2.895);
    for(var i = 0; i < counters; i ++) progress = progress + bprogress;
    // console.log(progress);
    statusObj.text('[ ' + progress + ']' + str_percent + ' %');
    }
    }, 100);
    },
    // callback for reset
    resetCallback: function() {
    console.log(script.answers.length);
    },
    //callback for every typed string
    onStringTyped: function() {
    console.log('after');
    clearTimeout(typing);
    statusObj.text('');
    terminal.scrollTop(terminal.height() * 100);
    },
    callback: function () {
    // Run next script
    pos = getRandomInt(min, max);
    var len = Object.keys(data).length;
    if (pos < len) {
    setTimeout(function () {
    terminal.append(notify);
    displayPrompt();
    nEdit = 0;
    // runScripts(data, pos);
    }, script.postDelay || 1000);
    }
    } });

    break;
    case 'view':

    break;}

    }

    function displayPrompt() {
    terminal.append('<span class=\'prompt\'>'+ prompt +' </span>');
    }

    // Delete n number of characters from the end of our output
    function erase(n) {
    command = command.slice(0, -n);
    terminal.html(terminal.html().slice(0, -n));
    }

    function clearCommand() {
    if (command.length > 0) {
    erase(command.length);
    }
    }
    var str_percent = 0;
    function appendCommand(str) {
    statusObj.text('');
    terminal.append(str);
    command += str;
    }

    terminal.mousedown(function(e){
    var input = $('.dummy-keyboard');
    var input_T = input.position().top;
    var input_L = input.position().left;
    var terminal_T = terminal.position().top ;
    input.css('position', 'absolute');
    input.css('margin-left', e.pageX - input_L);
    input.css('margin-top', e.pageY - input_T);
    });
    /*
    //  Keypress doesn't catch special keys,
    //  so we catch the backspace here and
    //  prevent it from navigating to the previous
    //  page. We also handle arrow keys for command history.
    */

    $(document).keydown(function (e) {
    e = e || window.event;
    var keyCode = typeof e.which === 'number' ? e.which : e.keyCode;

    // BACKSPACE
    if (keyCode === 8 && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    if (command !== '') {
    erase(1);
    }
    }

    // UP or DOWN
    if (keyCode === 38 || keyCode === 40) {
    // Move up or down the history
    if (keyCode === 38) {
    // UP
    historyIndex--;
    if (historyIndex < 0) {
    historyIndex++;
    }
    } else if (keyCode === 40) {
    // DOWN
    historyIndex++;
    if (historyIndex > commandHistory.length - 1) {
    historyIndex--;
    }
    }

    // Get command
    var cmd = commandHistory[historyIndex];
    if (cmd !== undefined) {
    clearCommand();
    appendCommand(cmd);
    }
    }
    });

    $(document).keypress(function (e) {
    // Make sure we get the right event
    e = e || window.event;
    var keyCode = typeof e.which === 'number' ? e.which : e.keyCode;
    if(nEdit) return;
    // Which key was pressed?
    switch (keyCode) {
    // ENTER
    case 13:
    {
    terminal.append('\n');
    $('#dummyKeyboard').val('');
    processCommand();
    displayPrompt();
    // console.log(terminal.prop("scrollHeight"));
    terminal.scrollTop(terminal.prop("scrollHeight") * 100);
    break;
    }
    default:
    {
    appendCommand(String.fromCharCode(keyCode));
    }}

    });

    // Set the window title
    title.text('Help about education');

    // Get the date & time
    var date = new Date().toString();
    date = date.substr(0, date.indexOf('GMT') - 1);
    // Display load from questions.txt and promt
    terminal.append("Last view: " + date +'\n\n');
    terminal.append('Enter the chapter <span class="question">' + commands[0].name + '</span> to continue:\n');
    displayPrompt();


    for(var i = 0; i < Object.keys(textlists).length; i ++){
      $.ajax({
        url: "text/" + textlists[i].name,
        async: false,
        cache: false,
        dataType: "text",
        success: function(data){
        textlists[i].content = data;
        }
      });
    }
    }
  )}
</script>
</html>
